<!DOCTYPE html>
<html>
  <head>
  <title>Pebble App for FHEM Home Automation Server</title>
  <link rel='stylesheet' type='text/css' href='css/slate.css'>
  <script src='js/slate.js'></script>
  <style>
  .title {
    padding: 15px 10px;
    text-transform: uppercase;
    font-family: 'PT Sans', sans-serif;
    font-size: 1.2em;
    font-weight: 500;
    color: #888888;
    text-align: center;
  }
  </style>
  </head>

  <body>
    <h1 class='title'>Pebble FHEM - Home Automation on your Wrist</h1>

    <div class='item-container'>
      <div class='item-container-content'>
        <div class='item-container-footer'>
	  Please dontate to support and motivate the further development of
	  this watch app by spending
	  <a
	    href="bitcoin:18YzPQVfQ5ss51uvgGJQ5MfbbK28S9ebbP?label=Pebble%20FHEM%20Donation"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Bitcoin_logo.svg/220px-Bitcoin_logo.svg.png" height="16"alt="Bitcoin" target="Donation"></a> (for more details see Wikipedia&#8217;s <a href="http://en.wikipedia.org/wiki/Bitcoin">Bitcoin</a>&nbsp;article).
	  
        </div>
      </div>
    </div>

    <div class='item-container'>
      <div class='item-container-header'>Server Configuration</div>
      <div class='item-container-content'>
        <label class='item'>
          Server URL
          <input id='FHEM_SERVER_URL' type='text' value='http://localhost:8083/fhem'>
        </label>
      </div>
      <div class='item-container-footer'>
	Please specify FHEM server URL. Note https is not yet supported as well
	as username/password access. Example: <em>http://www.myfhem.org:8083/fhem</em>.
      </div>
    </div>

    <div class='item-container'>
      <div class='item-container-header'>FS20 Devices <button id="RequestFS20fromFHEM">Request FS20 Devices</button></div>
      <div class='item-container-content'>
        <label class='item' id="FS20Content">
	  FS20 Device
	</label>
      </div>
      <div class='item-container-footer'>
	You can see all FS20 devices of your FHEM server.
      </div>
    </div>

    <!--div class='item-container'>
      <div class='item-container-header'>Accessibility</div>
      <div class='item-container-content'>
        <label class='item'>
          High Contrast Mode
          <input id='high_contrast_checkbox' type='checkbox' class='item-toggle'>
        </label>
      </div>
      <div class='item-container-footer'>
        This switches the app colors to a higher contrast set that promotes readability in low light.
      </div>
    </div-->

    <div class='item-container'>
      <div class='button-container'>
        <input id='submit_button' type='button' class='item-button' value='SUBMIT'>
      </div>
    </div>
  </body>
  <script>
  function getConfigData() {
    var FHEM_SERVER_URL_textinput = document.getElementById('FHEM_SERVER_URL');
    // var highContrastCheckbox = document.getElementById('high_contrast_checkbox');

    //alert("ServerUrl: "+FHEM_SERVER_URL_textinput.value);

    var options = {
      'FHEM_SERVER_URL': FHEM_SERVER_URL_textinput.value
    };
    //      // 'high_contrast': highContrastCheckbox.checked

    // alert("JSON: "+JSON.stringify(options));

    // Save for next launch
    localStorage['FHEM_SERVER_URL'] = options['FHEM_SERVER_URL'];
    // localStorage['high_contrast'] = options['high_contrast'];

    console.log('Got options: ' + JSON.stringify(options));
    return options;
  }

  function getQueryParam(variable, defaultValue) {
    var query = location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] === variable) {
        return decodeURIComponent(pair[1]);
      }
    }
    return defaultValue || false;
  }
 
  var submitButton = document.getElementById('submit_button');
  submitButton.addEventListener('click', function() {
    console.log('Submit');

    // Set the return URL depending on the runtime environment
    var return_to = getQueryParam('return_to', 'pebblejs://close#');
    document.location = return_to + encodeURIComponent(JSON.stringify(getConfigData()));
  });

    function HTTPGET(url) {
      var req = new XMLHttpRequest();
      req.open("GET", url, false);
      req.send(null);
      return req.responseText;
    }

  function ProcessRequestedType(DevJSON)
  {
    var FS20Element=document.getElementById('FS20Content');
    
    FS20Element.innerHTML = "Response: " + JSON.stringify(DevJSON);

    FS20Element.innerHTML = 'FS20Element.innerHTML + 'Received Devices: ' + DevJSON.totalResultsReturned;

    // FS20Element.innerHTML = 'Received Devices: ' + NumberOfElements;
    // FS20Element.innerHTML = JSON.stringify(DevJSON.Results[0].Internals);
  }

  var RequestButton = document.getElementById('RequestFS20fromFHEM');
  RequestButton.addEventListener('click', function() {
    console.log('RequestButton entered');

    var FS20Element=document.getElementById('FS20Content');

    URL = localStorage['FHEM_SERVER_URL']+ "?cmd=jsonlist2%20TYPE=FS20&XHR=1";

    FS20Element.innerHTML = "Requesting FS20 from " + URL;
    
    // var response = HTTPGET(URL);
    
    var req = new XMLHttpRequest();
    req.onreadystatechange = function() {
	if (req.readyState == 4) { //  && req.status == 200) {
    		FS20Element.innerHTML = "State: " + req.readyState + " HTTP status: " + req.statusText;
    		var myArr = JSON.parse(req.responseText);
    		ProcessRequestedType(myArr);
    	} else {
    		FS20Element.innerHTML = "State: " + req.readyState + " HTTP status: " + req.statusText;
    	}
    };
    req.open("GET", URL, true);
    req.send(null);

    //FS20Element.innerHTML = "Response: " + response;

    //var DevJSON = JSON.parse(response);
    // var NumberOfElements = 42; // DevJSON.totalResultsReturned;

    //FS20Element.innerHTML = 'Received Devices: ' + DevJSON.totalResultsReturned;

    // FS20Element.innerHTML = 'Received Devices: ' + NumberOfElements;
    //FS20Element.innerHTML = JSON.stringify(DevJSON.Results[0].Internals);

    console.log('RequestButton leave');

    // alert('Received Devices: ' + DevJSON.totalResultsReturned);
  });

  (function() {
    var FHEM_SERVER_URL_textinput = document.getElementById('FHEM_SERVER_URL');
    // var highContrastCheckbox = document.getElementById('high_contrast_checkbox');

    // Load any previously saved configuration, if available
    if(localStorage['FHEM_SERVER_URL']) {
      FHEM_SERVER_URL_textinput.value = localStorage['FHEM_SERVER_URL'];
      //highContrastCheckbox.checked = JSON.parse(localStorage['high_contrast']);
    }
  })();
  </script>
</html>
