<!-- Example URL:
http://madita/config/index.html?options=%7B%22FS20%22%3A%5B%7B%22State%22%3A%22toggle%22%2C%22Device%22%3A%22FS20_fr_bel%22%2C%22Descr%22%3A%22Licht%20umschalten%22%2C%22Room%22%3A%22K%C3%BCche%22%7D%2C%7B%22State%22%3A%22toggle%22%2C%22Device%22%3A%22FS20_fz_bel%22%2C%22Descr%22%3A%22Licht%20an%2Faus%22%2C%22Room%22%3A%22Wohnzimmer%22%7D%5D%2C%22num%22%3A2%7D&return_to=https%3A//cloudpebble.net/ide/emulator/config%3F
https://rawgit.com/chelaz/MyFHEM2/master/config/index.html?options=%7B%22FS20%22%3A%5B%7B%22State%22%3A%22toggle%22%2C%22Device%22%3A%22FS20_fr_bel%22%2C%22Descr%22%3A%22Licht%20umschalten%22%2C%22Room%22%3A%22K%C3%BCche%22%7D%2C%7B%22State%22%3A%22toggle%22%2C%22Device%22%3A%22FS20_fz_bel%22%2C%22Descr%22%3A%22Licht%20an%2Faus%22%2C%22Room%22%3A%22Wohnzimmer%22%7D%5D%2C%22num%22%3A2%7D&return_to=https%3A//cloudpebble.net/ide/emulator/config%3F
-->


<!DOCTYPE html>
<html>
  <head>
  <title>Pebble App for FHEM Home Automation Server</title>
  <link rel='stylesheet' type='text/css' href='css/slate.css'>
  <script src='js/slate.js'></script>
  <style>
  .title {
    padding: 15px 10px;
    text-transform: uppercase;
    font-family: 'PT Sans', sans-serif;
    font-size: 1.2em;j
    font-weight: 500;
    color: #888888;
    text-align: center;
  }
  </style>
  </head>

  <body>
    <h1 class='title'>Pebble FHEM - Home Automation on your Wrist - Commit 27
    </h1>

    <div class='item-container'>
      <div class='item-container-content'>
        <div class='item-container-footer'>
	  Please dontate to support and motivate the further development of
	  this watch app by spending
	  <a
	    href="bitcoin:18YzPQVfQ5ss51uvgGJQ5MfbbK28S9ebbP?label=Pebble%20FHEM%20Donation"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Bitcoin_logo.svg/220px-Bitcoin_logo.svg.png" height="16"alt="Bitcoin" target="Donation"></a> (for more details see Wikipedia&#8217;s <a href="http://en.wikipedia.org/wiki/Bitcoin">Bitcoin</a>&nbsp;article).
	  
        </div>
      </div>
    </div>

    <div class='item-container'>
      <div class='item-container-header'>Server Configuration</div>
      <div class='item-container-content'>
        <label class='item'>
          Server URL
          <input id='FHEM_SERVER_URL' type='text' value='http://localhost:8083/fhem'>
        </label>
      </div>
      <div class='item-container-footer'>
	Please specify FHEM server URL. Note https is not yet supported as well
	as username/password access. Example: <em>http://www.myfhem.org:8083/fhem</em>.
      </div>
    </div>

    <div class='item-container'>
      <div class='item-container-header'>FS20 Devices <!-- button id="RequestFS20fromFHEM">Request FS20 Devices</button--></div>
      <div class='item-container-content'>
        <div id="FS20Content">...</div>
      </div>
      <div class='item-container-footer'>
	You can see all FS20 devices of your FHEM server.
      </div>
    </div>

    <!--div class='item-container'>
      <div class='item-container-header'>Accessibility</div>
      <div class='item-container-content'>
        <label class='item'>
          High Contrast Mode
          <input id='high_contrast_checkbox' type='checkbox' class='item-toggle'>
        </label>
      </div>
      <div class='item-container-footer'>
        This switches the app colors to a higher contrast set that promotes readability in low light.
      </div>
    </div-->

    <div class='item-container'>
      <div class='button-container'>
        <input id='submit_button' type='button' class='item-button' value='SUBMIT'>
      </div>
    </div>
  </body>
  
  <script>

  function GetInputServerURL(return_opts)
  {
    var FHEM_SERVER_URL_textinput = document.getElementById('FHEM_SERVER_URL');
    return_opts['FHEM_SERVER_URL'] = FHEM_SERVER_URL_textinput.value;

    // Save for next launch
    localStorage['FHEM_SERVER_URL'] = return_opts['FHEM_SERVER_URL'];

    return return_opts;
  }

  function GetInputDevices(return_opts, DeviceType)
  {
    var Key = "FHEM_DEVICES_" + DeviceType;
    
    var options = JSON.parse(localStorage[Key]);
    
    if (options.num == null || options.num == 0)
      return return_opts;
    
    var FHEM_Types = {}
    FHEM_Types[DeviceType] = [];
    // FHEM_Types.num = 0;

    console.log('FHEM_TYPES: ' + JSON.stringify(FHEM_Types));

    var cnt=0;
    for (var i=0; i < options.num; i++) {
      var InputID = "Device_" + i;
      var InputElem = document.getElementById(InputID);

      if (InputElem.checked) {
        FHEM_Types[DeviceType].push( 
         { 
          "State"  : options[DeviceType][i].State,
          "Device" : options[DeviceType][i].Device,
          "Descr"  : options[DeviceType][i].Descr,
          "Room"   : options[DeviceType][i].Room
         });
        options[DeviceType][i].checked = true;
        cnt++;
      } else
        options[DeviceType][i].checked = false;
    }
    // FHEM_Types[DeviceType].push({ 'num' : cnt });
    
    // return_opts[DeviceType] = FHEM_Types[DeviceType];
    // return return_opts;

    return_opts['TypeDevices'] = FHEM_Types;
    return return_opts;
  }

  /////////////////////////////////////
  // Get data from html form input tags
  function getUserInput() {
    // var highContrastCheckbox = document.getElementById('high_contrast_checkbox');

    /* var options = {
      'FHEM_SERVER_URL': FHEM_SERVER_URL_textinput.value
    }; */
    //      // 'high_contrast': highContrastCheckbox.checked

    // localStorage['high_contrast'] = options['high_contrast'];

    DeviceType = "FS20";

    var options = {}

    options = GetInputServerURL(options);    
    options = GetInputDevices(options, DeviceType);

    console.log('Got options: ' + JSON.stringify(options));
    return options;
  }

  /////////////////////////////////////
  // Helper Function:
  // Set the return URL depending on the runtime environment
  function getQueryParam(variable, defaultValue) {
    var query = location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] === variable) {
        return decodeURIComponent(pair[1]);
      }
    }
    return defaultValue || false;
  }

  /////////////////////////////////////
  // Submit button clicked 
  var submitButton = document.getElementById('submit_button');
  submitButton.addEventListener('click', function() {
    console.log('Submit');

    var return_to = getQueryParam('return_to', 'pebblejs://close#');
    document.location = return_to + encodeURIComponent(JSON.stringify(getUserInput()));
  });


  /////////////////////////////////////
  // Helper Function:
  // Extract the args from the URI of this document
  // Returns the string corresponding to the given key
  function getQueryString(key, default_) {
	  if (default_ == null) default_ = "";
	  key = key.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
	  var regex = new RegExp("[\\?&]" + key + "=([^&#]*)");
	  var qs = regex.exec(window.location.href);
	  if (qs == null)
	    return default_;
	  else
	    return decodeURIComponent(qs[1]);
  }

  /////////////////////////////////////
  // Fetches all devices from args (URI) and shows it on the page
  function ShowDevicesFromArgs(DeviceType, HTMLElement)
  {
    var optionsString = getQueryString("options", "{" + DeviceType + ":''}");
    var options = JSON.parse(optionsString);

    var Key = "FHEM_DEVICES_" + DeviceType;
    localStorage[Key] = optionsString;

    if (options.num == null) {
      HTMLElement.innerHTML = "Nothing received from Pebble.js";
      return;
    }
    if (options.num == 0) {
      HTMLElement.innerHTML = "No " + DeviceType + " devices found";
      return;
    }

    HTMLElement.innerHTML = "";

    // checked not yet working since the data from localStorage is overwritten above
    for (var i = 0; i < options.num; i++) {
      var ih = i+1;
      HTMLElement.innerHTML +=
         "<label>" + 
         " [" + ih + "/" + options.num + "] " + 
         "  <input id='Device_" + i + "' type='checkbox' "+
	 "   value=" + options[DeviceType][i].checked +
	 "  >&nbsp;" +
	 options[DeviceType][i].Room +
	 "   </label>" +
	 "  <input id='Device_" + i + "_descr' type='text' "+ 
	 "   value='" + options[DeviceType][i].Descr + "'>";
	 
	 HTMLElement.innerHTML += 
	   "<div class='item-container-content-small'>" +
	   " <table border='1'>" +
	   "  <tr id = 'toggle'>" +
	   "    <td><label>" +
           "       Fav<input id='Device_" + i + "_toggle_fav' type='checkbox' "+
	   "           value=" + options[DeviceType][i].checked + ">" +
	   "    </label></td>" +
	   "    <td><label>" +
           "       Dict<input id='Device_" + i + "_toggle_dict' type='checkbox' "+
	   "            value=" + options[DeviceType][i].checked + ">" +
	   "    </label></td>" +
	   "    <td><label>" +
           "       <input id='Device_" + i + "_toggle_state' type='text' "+
	   "        value='toggle'>" +
	   "    </label></td>" +
	   "  </tr>" +
	   "  <tr id = 'on'>" +
	   "    <td><label>" +
           "       Fav<input id='Device_" + i + "_on_fav' type='checkbox' "+
	   "           value=" + options[DeviceType][i].checked + ">" +
	   "    </label></td>" +
	   "    <td><label>" +
           "       Dict<input id='Device_" + i + "_on_dict' type='checkbox' "+
	   "            value=" + options[DeviceType][i].checked + ">" +
	   "    </label></td>" +
	   "    <td><label>" +
           "       <input id='Device_" + i + "_on_state' type='text' "+
	   "        value='on'>" +
	   "    </label></td>" +
	   "  </tr>" +
	   " </table>" +
	   "</div>";
	   
/*
	 
         "   <div class='item-container-content-small'>" +
	  // options[DeviceType][i].Descr +
	 "     <label>" +
         "       <input id='Device_" + i + "_toggle' type='checkbox' "+
	 "       value=" + options[DeviceType][i].checked +
	 "       >&nbsp;" + "toggle" +
	 "     </label>" +	 
	 "     <label>" +
         "       <input id='Device_" + i + "_on' type='checkbox' "+
	 "       value=" + options[DeviceType][i].checked +
	 "       >&nbsp;" + "on" +
	 "     </label>" +	 
	 "     <label>" +
         "       <input id='Device_" + i + "_off' type='checkbox' "+
	 "       value=" + options[DeviceType][i].checked +
	 "       >&nbsp;" + "off" +
	 "     </label>" +	 
	 "     <label>" +
         "       <input id='Device_" + i + "_state' type='checkbox' "+
	 "       value=" + options[DeviceType][i].checked +
	 "       >&nbsp;" + "state" +
	 "     </label>" +	 
	 "   </div>" + 
	 "  "+
	 "";
	 */
    }
  }

  /////////////////////////////////////
  // Main Function
  (function() {
    var FHEM_SERVER_URL_textinput = document.getElementById('FHEM_SERVER_URL');
    // var highContrastCheckbox = document.getElementById('high_contrast_checkbox');

    // Load any previously saved configuration, if available
    if(localStorage['FHEM_SERVER_URL']) {
      FHEM_SERVER_URL_textinput.value = localStorage['FHEM_SERVER_URL'];
      //highContrastCheckbox.checked = JSON.parse(localStorage['high_contrast']);
    }
    
    // for debugging: if args of URI are not present, the URI stays
    var FS20Element=document.getElementById('FS20Content');
    FS20Element.innerHTML = "URL of this document: <em>" + window.location.href + "</em>";

    ShowDevicesFromArgs("FS20", FS20Element);

  })();
  </script>
</html>
