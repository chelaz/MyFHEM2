<!-- Example URL:
http://madita/html/config.html?options=%7B%22FS20%22%3A%5B%7B%22State%22%3A%22toggle%22%2C%22Device%22%3A%22FS20_fr_bel%22%2C%22Alias%22%3A%22Licht%20umschalten%22%2C%22Room%22%3A%22K%C3%BCche%22%7D%2C%7B%22State%22%3A%22toggle%22%2C%22Device%22%3A%22FS20_fz_bel%22%2C%22Alias%22%3A%22Licht%20an%2Faus%22%2C%22Room%22%3A%22Wohnzimmer%22%7D%5D%2C%22num%22%3A2%7D&return_to=https%3A//cloudpebble.net/ide/emulator/config%3F
https://rawgit.com/chelaz/WristFHEM/master/html/config.html?options=%7B%22FS20%22%3A%5B%7B%22State%22%3A%22toggle%22%2C%22Device%22%3A%22FS20_fr_bel%22%2C%22Alias%22%3A%22Licht%20umschalten%22%2C%22Room%22%3A%22K%C3%BCche%22%7D%2C%7B%22State%22%3A%22toggle%22%2C%22Device%22%3A%22FS20_fz_bel%22%2C%22Alias%22%3A%22Licht%20an%2Faus%22%2C%22Room%22%3A%22Wohnzimmer%22%7D%5D%2C%22num%22%3A2%7D&return_to=https%3A//cloudpebble.net/ide/emulator/config%3F
// with date:
https://rawgit.com/chelaz/WristFHEM/master/html/config.html?options={%22FS20%22%3A[{%22State%22%3A%22toggle%22%2C%22Device%22%3A%22FS20_fr_bel%22%2C%22Descr%22%3A%22Licht%20umschalten%22%2C%22Room%22%3A%22K%C3%BCche%22}%2C{%22State%22%3A%22toggle%22%2C%22Device%22%3A%22FS20_fz_bel%22%2C%22Descr%22%3A%22Licht%20an%2Faus%22%2C%22Room%22%3A%22Wohnzimmer%22}]%2C%22num%22%3A2%2C%22Date%22%3A%2215.12.%22}&return_to=https%3A//cloudpebble.net/ide/emulator/config%3F
-->

<!--
  Documenation of JSON Data Exchange
  ----------------------------------
  
  From PebbleJS: FHEM_Devices
  --------------
  	{ "FS20" : [
  		{ "State"  : "toggle",
  		  "Device" : "FS20_fr_bel",
  		  "Alias"  : "Licht umschalten",
  		  "Room"   : "KÃ¼che"
  		},
  		{ "State"  : "toggle",
  		  "Device" : "FS20_fz_bel",
  		  "Alias"  : "Licht an/aus",
  		  "Room"   : "Wohnzimmer"
  		}
  	  ],
  	  "num" : 2,
  	  "Date" : "15.12.2015 12.00"
  	}
  
  
  To PebbleJS:   FHEM_Config
  --------------
	{ "FHEM_SERVER_URL"  : "http://localhost:8083/fhem",
	  "FHEM_ROOM_FILTER" : "Pebble",
	  "Cfg_Devices"     : {
	  	"FS20" : [
	  	  { "State"     : "toggle",
	  	    "StateText" : "umschalten",
	  	    "Device"    : "FS20_fr_bel",
	  	    "Alias"     : "Licht",
	  	    "Descr"     : "Licht umschalten",
	  	    "Room"      : "Kitchen",
	  	    "Check"     : 2
	  	  },
	  	  { "State"     : "on",
	  	    "StateText" : "an",
	  	    "Device"    : "FS20_fr_bel",
	  	    "Alias"     : "Licht",
	  	    "Descr"     : "Licht an",
	  	    "Room"      : "Kitchen",
	  	    "Check"     : 1
	  	  },
	  	  { "State"     : "off",
	  	    "StateText" : "aus",
	  	    "Device"    : "FS20_fr_bel",
	  	    "Alias"     : "Licht",
	  	    "Descr"     : "Licht aus",
	  	    "Room"      : "Kitchen",
	  	    "Check"     : 1
	  	  },
	  	  ...
	  	]
	  }
	}


  // local storage:
  FHEM_SERVER_URL
  FHEM_ROOM_FILTER
  FHEM_DEVICES_FS20 see FHEM_Devices above
  FHEM_Config       see Cfg_Devices above (to use previous settings)
-->


<!DOCTYPE html>
<META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
<html>
  <div id="CommitNumber" hidden> 63 </div>
  <head>
  <title>WristFHEM - Pebble App for FHEM Home Automation Server</title>
  <link rel='stylesheet' type='text/css' href='css/slate.css'>
  <!--script src='js/slate.js'></script-->
  <style>
  .title {
    padding: 15px 5px;
    font-family: 'PT Sans', sans-serif;
    color: #888888;
    text-align: center;
  }
  .subtitle {
    padding: 5px 5px;
    font-family: 'PT Sans', sans-serif;
    font-size: 1em;
    font-weight: 500;
    color: #888888;
    text-align: center;
  }
  </style>
  </head>

  <body>
    <h1 class='title'><a href="http://www.chelaz.de/WristFHEM">WristFHEM</a></h1>
    <h1 class='subtitle'>Home Automation on your Wrist</h1>

    <div class='item-container'>
      <div class='item-container-content'>
        <div class='item-container-footer'>
	  Please dontate to support and motivate the further development of
	  this watch app by spending
	  <a
	    href="bitcoin:18YzPQVfQ5ss51uvgGJQ5MfbbK28S9ebbP?label=Pebble%20FHEM%20Donation"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Bitcoin_logo.svg/220px-Bitcoin_logo.svg.png" height="16" alt="Bitcoin" target="Donation"></a> (for more details see Wikipedia&#8217; <a href="http://en.wikipedia.org/wiki/Bitcoin">Bitcoin</a>&nbsp;article).
	  
        </div>
      </div>
    </div>

    <div class='item-container'>
      <div class='item-container-header'>Server Configuration</div>
      <div class='item-container-content'>
        <label class='item'>
          Server URL
          <input id='FHEM_SERVER_URL' type='text' value='http://localhost:8083/fhem'>
        </label>
        <label class='item'>
          Room Filter
          <input id='FHEM_ROOM_FILTER' type='text' value='Pebble'>
        </label>
      </div>
      <div class='item-container-footer'>
<p>
	Please specify <a href="http://www.fhem.de">FHEM</a> server URL. Note https is not yet supported as well
	as username/password access. Example: <em>http://www.myfhem.org:8083/fhem</em>.</p>
<p>Optionally you can specify a
room. All devices are filtered by this room after requesting the new devices
from your watch.</p>
      <div align=right><input id='reset_button'  type='button' class='item-button-small' value='Reset'>
      </div>
     </div>    
    </div>

    <div class='item-container'>
      <div class='item-container-header' id="FHEMDevices_header">FHEM Devices</div>
      <div class='item-container-content'>
        <div id="FHEMDevices">...</div>
      </div>
      <div class='item-container-footer'>
	You can see all (filtered) devices of your FHEM server.
      </div>
    </div>

    <!--div class='item-container'>
      <div class='item-container-header'>Accessibility</div>
      <div class='item-container-content'>
        <label class='item'>
          High Contrast Mode
          <input id='high_contrast_checkbox' type='checkbox' class='item-toggle'>
        </label>
      </div>
      <div class='item-container-footer'>
        This switches the app colors to a higher contrast set that promotes readability in low light.
      </div>
    </div-->

    <div class='item-container'>
      <div class='button-container'>
        <input id='submit_button' type='button' class='item-button' value='SUBMIT'>
      </div>
    </div>
    <!-- DEBUG_CONSOLE -->
    <!-- div class='item-container'>
      <div class='item-container-header'>Debug Console</div>
      <div class='item-container-footer'><ul id="Console"><li>Status: Ready</li></ul>
      </div>
    </div -->
  </body>
  
  
  <!-- --------------------------------------------------------------------------------------------------
  	javascript starts here -->
  <script>
  
  var Debug=false;
  
  
  
  ////////////////////////////////////
  // General Helper Functions

  // Set the return URL depending on the runtime environment
  function getQueryParam(variable, defaultValue) {
    var query = location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] === variable) {
        return decodeURIComponent(pair[1]);
      }
    }
    return defaultValue || false;
  }

  // Extract the args from the URI of this document
  // Returns the string corresponding to the given key
  // Example: var optionsString = getQueryString("options", "foobar");  // for "URL=https://localhost/index.html?options=FOOBAR"
  function getQueryString(key, default_) {
	  if (default_ == null) default_ = "";
	  key = key.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
	  var regex = new RegExp("[\\?&]" + key + "=([^&#]*)");
	  var qs = regex.exec(window.location.href);
	  if (qs == null)
	    return default_;
	  else
	    return decodeURIComponent(qs[1]);
  }

  /////////////////////////////////////
  // Submit button clicked 
  var submitButton = document.getElementById('submit_button');
  submitButton.addEventListener('click', function() {
    console.log('Submit');

    var ReturnString = JSON.stringify(getInputMain());

    MyConsole("Submit: "+ ReturnString);

    if (Debug)
      return;

    var return_to = getQueryParam('return_to', 'pebblejs://close#');
    document.location = return_to + encodeURIComponent(ReturnString);
  });


  var resetButton = document.getElementById('reset_button');
  resetButton.addEventListener('click', function() {
    var r = confirm("Do you really want to reset all settings?");
    if (r != true) {
      // reload same page
      var location=document.location;
      document.location = location;
      return;
    }
    MyConsole("Reset clicked. Cleaning local storage");

    localStorage['FHEM_SERVER_URL']  = "";
    localStorage['FHEM_ROOM_FILTER'] = "";

    var DeviceType = "FS20";
    var Key = "FHEM_DEVICES_" + DeviceType;
    localStorage[Key] = "";
    localStorage["FHEM_Config"] = "";
    MyConsole("Cleaning local storage done");

    // reload same page
    var location=document.location;
    document.location = location;
  });

  function MyConsole(text)
  {
    // DEBUG_CONSOLE
    // var Console = document.getElementById('Console');
    // Console.innerHTML += "<li>" + text + "</li>";
  }

  ////////////////////////////////////
  // Defines for checkbuttons
  var MenuDef   = 1;
  var MenuFav   = 2;
  var MenuState = 4;

  // -----------------------------------------------------
  // Read data from HTML Input

  function GetInputServerURL(return_opts)
  {
    var FHEM_SERVER_URL_textinput = document.getElementById('FHEM_SERVER_URL');
    return_opts['FHEM_SERVER_URL'] = FHEM_SERVER_URL_textinput.value;

    var FHEM_ROOM_FILTER_textinput = document.getElementById('FHEM_ROOM_FILTER');
    return_opts['FHEM_ROOM_FILTER'] = FHEM_ROOM_FILTER_textinput.value;

    // Save for next launch
    localStorage['FHEM_SERVER_URL']  = return_opts['FHEM_SERVER_URL'];
    localStorage['FHEM_ROOM_FILTER'] = return_opts['FHEM_ROOM_FILTER'];

    return return_opts;
  }

  /*
    IDs: 
       Room (check) Device_0
       Room Label:  Device_0_room
                    Device_0_room_button
       Descr:       Device_0_descr
                    Device_0_descr_button

       Check_fav_t: Device_0_toggle_fav
       Check_dict:  Device_0_toggle_dict
                    Device_0_toggle_text        (text: toggle/umschalten)
                    Device_0_toggle_text_button
                    Device_0_on_fav
                    Device_0_on_dict
                    Device_0_on_text
                    Device_0_on_text_button
                    Device_0_off_fav
                    Device_0_off_dict
                    Device_0_off_text
                    Device_0_off_text_button
                    Device_0_state     
  */

  // Helper function
  function AddCfgDeviceFromInput(Cfg_Devices_Type,
  				 IDBasename,
  				 DeviceName,
  				 HtmlRoomText_value,
  				 HtmlDescrText_value,
  				 state)
  {
    var IDCheckBasename = IDBasename + "_" + state;
    var HtmlFav  = document.getElementById(IDCheckBasename+"_fav");
    var HtmlDict = document.getElementById(IDCheckBasename+"_dict");
    var HtmlStateText = document.getElementById(IDCheckBasename+"_text");
    var CheckBits = (HtmlDict.checked) ? MenuDef : 0;
    CheckBits    |= (HtmlFav.checked)  ? MenuFav : 0;
         
    if (CheckBits != 0) {
      Cfg_Devices_Type.push( 
           { 
            "State"     : state,
            "StateText" : HtmlStateText.value,
            "Device"    : DeviceName,
            "Alias"     : HtmlDescrText_value,
            "Descr"     : HtmlDescrText_value + " " + HtmlStateText.value,
            "Room"      : HtmlRoomText_value,
            "Check"     : CheckBits
           });
       return true;
     }
     return false;
  }
  

  function GetInputDevices(return_opts, DeviceType)
  {
    // todo: rearrange localstorage for Cfg_Devices
    
    var Key = "FHEM_DEVICES_" + DeviceType;
    
    if (localStorage[Key] == "")
      return return_opts;

    var FHEM_Devices = JSON.parse(localStorage[Key]);
    
    if (FHEM_Devices.num == null || FHEM_Devices.num == 0)
      return return_opts;
    
    var Cfg_Devices = {}
    Cfg_Devices[DeviceType] = [];
    // console.log('Cfg_Devices: ' + JSON.stringify(FHEM_Devices));
    var cnt=0;
    for (var j=0; j < FHEM_Devices.num; j++) {    	
      // fetch all IDs in the order of appearance of div with ID ComItem_j
      var ComIDDiv = document.getElementById("ComItem_" + j);
      var ID = ComIDDiv.firstElementChild.id;

      var IDBasename     = "Device_" + ID;
      var HtmlCk         = document.getElementById(IDBasename);
      var HtmlDescrText  = document.getElementById(IDBasename+"_descr");
      var HtmlRoomText   = document.getElementById(IDBasename+"_room");
      
      if (HtmlCk.checked) {
      	
      	if (AddCfgDeviceFromInput(Cfg_Devices[DeviceType], IDBasename, FHEM_Devices[DeviceType][ID].Device, 
  				 HtmlRoomText.value, HtmlDescrText.value, "toggle"))
  	  cnt++;
      	if (AddCfgDeviceFromInput(Cfg_Devices[DeviceType], IDBasename, FHEM_Devices[DeviceType][ID].Device, 
  				 HtmlRoomText.value, HtmlDescrText.value, "on"))
  	  cnt++;
      	if (AddCfgDeviceFromInput(Cfg_Devices[DeviceType], IDBasename, FHEM_Devices[DeviceType][ID].Device, 
  				 HtmlRoomText.value, HtmlDescrText.value, "off"))
  	  cnt++;
      	
        
        var HtmlState      = document.getElementById(IDBasename+"_state");
        if (HtmlState.checked != 0) {
          Cfg_Devices[DeviceType].push( 
           { 
            "State"     : "toggle",
            "StateText" : "toggle", /* irrelevant */
            "Device" : FHEM_Devices[DeviceType][ID].Device,
            "Alias"  : HtmlDescrText.value,
            "Descr"  : HtmlDescrText.value,
            "Room"   : HtmlRoomText.value,
            "Check"  : MenuState
           });
          cnt++;
        }
        cnt++;
      } else
        FHEM_Devices[DeviceType][ID].checked = false;
    }
    return_opts['Cfg_Devices'] = Cfg_Devices;
    return return_opts;
  }

  // Input main function
  function getInputMain() {

    DeviceType = "FS20";

    var FHEM_Config = {}

    FHEM_Config = GetInputServerURL(FHEM_Config);    
    FHEM_Config = GetInputDevices(FHEM_Config, DeviceType);

    var FHEM_Config_Str = JSON.stringify(FHEM_Config);

    MyConsole("FHEM_Config: " + FHEM_Config_Str);

    localStorage["FHEM_Config"] = FHEM_Config_Str;

    return FHEM_Config;
  }


  // -----------------------------------------------------
  // ...


  /////////////////////////////////////
  // Helper Functions

  // A button shows a text. If the user presses on the button
  // an edit control appears with the same text.
  // Used for the following HTML input:
  //  <label>
  //    <input id="inputID"  type="hidden" value="Text">
  //    <input id="buttonID" type="button" value="Text"
  //           onclick='ShowEdit("inputID","buttonID");'>
  //  </label>
  function ShowEdit(inputID, buttonID)
  {
    var HTMLInput = document.getElementById(inputID);
    HTMLInput.type = "text";
    var HTMLButton = document.getElementById(buttonID);
    HTMLButton.type = "hidden";
   }

  function CheckDevice(DeviceID)
  {
    //DeviceID.checked = true;
    var DeviceCkInput = document.getElementById(DeviceID);
    DeviceCkInput.checked = true;
   }

  /////////////////////////////////////
  // Fetches all devices from args (URI) and shows it on the page
  function ShowDevicesFromArgs(DeviceType, HTMLElement)
  {
    // previous configuration:
    function FindDeviceStates(CfgDevices, Device)
    {
      var StatesArr = [];
      for (var D in CfgDevices) {
        if (CfgDevices[D].Device == Device)
          StatesArr.push(CfgDevices[D]);
      }
      return StatesArr;
    }

    function AddCfgDevState2Device(i, CfgDev)
    {
      var DeviceID     = "Device_" + i;
      var InputIDBase  = DeviceID + "_" + CfgDev.State;
      var EditID       = "\"" + InputIDBase + "_text\"";
      var EditIDButton = "\"" + InputIDBase + "_text_button\"";

      var CheckedDevStr = (CfgDev.Check & MenuDef) ? "checked" : "";
      var CheckedFavStr = (CfgDev.Check & MenuFav) ? "checked" : "";

      var RetStr = 	
	   "  <tr>\n" +
	   "    <td><label>\n" +
           "       <input id='" + InputIDBase + "_fav'"+
           "        type='checkbox' " + CheckedFavStr + 
           "        onclick='CheckDevice(\"" + DeviceID + "\");'>\n" +
	   "    </label></td>\n" +
	   "    <td><label>\n" +
           "       <input id='" + InputIDBase + "_dict'"+
           "        type='checkbox' " + CheckedDevStr +
           "        onclick='CheckDevice(\"" + DeviceID + "\");'>\n" +
	   "    </label></td>\n" +
	   "    <td><label>\n" +
           "       <input id=" + EditID       + " type='hidden' "+
	   "           value=" + CfgDev.StateText + ">\n" + 
	   "       <input id=" + EditIDButton + " type='button' value='" + CfgDev.StateText +
	   "        ' onclick='ShowEdit(" + EditID +"," + EditIDButton + ");'>" +
	   "    </label></td>\n" +
	   "  </tr>\n\n";
	   
      // console.log(RetStr);
      return RetStr;
    };


    function AddState2Device(i, Device, State, StateText)
    {
      var DeviceID     = "Device_" + i;
      var EditID       = "\"Device_" + i + "_" + State + "_text\"";
      var EditIDButton = "\"Device_" + i + "_" + State + "_text_button\"";
      var RetStr = 	
	   "  <tr>\n" +
	   "    <td><label>\n" +
           "       <input id='Device_" + i + "_" + State + "_fav' type='checkbox' "+
	   "        value='" + Device[i].checked + "'" +
           "        onclick='CheckDevice(\"" + DeviceID + "\");'>\n" +
	   "    </label></td>\n" +
	   "    <td><label>\n" +
           "       <input id='Device_" + i + "_" + State + "_dict' type='checkbox'"+
	   "           value='" + Device[i].checked + "'" +
           "        onclick='CheckDevice(\"" + DeviceID + "\");'>\n" +
	   "    </label></td>\n" +
	   "    <td><label>\n" +
           "       <input id=" + EditID       + " type='hidden' "+
	   "           value='" + StateText + "'>\n" + 
	   "       <input id=" + EditIDButton + " type='button' value='" + StateText +
	   "        ' onclick='ShowEdit(" + EditID +"," + EditIDButton + ");'>" +
	   "    </label></td>\n" +
	   "  </tr>\n\n";
	   
      // console.log(RetStr);
      return RetStr;
    };

    var Default_FHEM_Devices = "{" + DeviceType + ":''}";
    var FHEM_DevicesString = getQueryString("options", Default_FHEM_Devices);
    
    MyConsole("From PebbleJS: "+FHEM_DevicesString);
    
    var FHEM_Devices = JSON.parse(FHEM_DevicesString);

    var Key = "FHEM_DEVICES_" + DeviceType;
    localStorage[Key] = FHEM_DevicesString;

    if (FHEM_Devices.num == null) {
      HTMLElement.innerHTML = "Nothing received from Pebble.js";
      return;
    }
    if (FHEM_Devices.num == 0) {
      HTMLElement.innerHTML = "No " + DeviceType + " devices found";
      return;
    }

    if (FHEM_Devices.Date)
	HTMLElement.innerHTML = "<div class='item-container-footer'>Last Update from FHEM server: " + FHEM_Devices.Date + "</div>";
    else
	HTMLElement.innerHTML = "";

    var FHEM_Config_prev = {};
    
    if (localStorage["FHEM_Config"])
      FHEM_Config_prev = JSON.parse(localStorage["FHEM_Config"]);

    MyConsole("FHEM_Config_prev: " + JSON.stringify(FHEM_Config_prev));

    var DeviceType_prev;

    if (FHEM_Config_prev) {
      var Cfg_Devices_prev = FHEM_Config_prev['Cfg_Devices'];
      if (Cfg_Devices_prev)
        DeviceType_prev = Cfg_Devices_prev[DeviceType];
    }

    // first build empty tags
    for (var i = 0; i < FHEM_Devices.num; i++) {
      HTMLElement.innerHTML += 
         "<div class='item-container-content' id='ComItem_" + i + "'></div>";
    }

    var FoundDevices=0;
    for (var i = 0; i < FHEM_Devices.num; i++) {
      var Device = FHEM_Devices[DeviceType][i].Device;
      var Alias  = FHEM_Devices[DeviceType][i].Alias;
      var Room   = FHEM_Devices[DeviceType][i].Room;

      var StateChecked = false;

      var DeviceCheckedStr = "";
      var StatesArr = [];
      if (DeviceType_prev) {
        StatesArr = FindDeviceStates(DeviceType_prev, Device);
        if (StatesArr.length > 0) {
          Alias = StatesArr[0].Alias;
          Room  = StatesArr[0].Room;
          DeviceCheckedStr = "checked";
        }
      }

      var DeviceID     = "Device_" + i;

      var RoomID       = "\"Device_" + i + "_room\"";
      var RoomIDButton = "\"Device_" + i + "_room_button\"";

      var AliasID       = "\"Device_" + i + "_descr\"";
      var AliasIDButton = "\"Device_" + i + "_descr_button\"";

      var ih = i+1;      
      var HTMLDevice =
         // "<div class='item-container-content'>"+
         "   <label id='" + i + "'>" + 
         "     <!-- [" + ih + "/" + FHEM_Devices.num + "] -->" + 

         "     <input id='" + DeviceID + "' type='checkbox' "+DeviceCheckedStr+">"+
	 "   </label>" +
         "       <input id=" + RoomID       + " type='hidden' class='button-room' " +
	 "           value='" + Room + "'>\n" + 
	 "       <input id=" + RoomIDButton + " type='button' class='button-room' " +
         "           value='" + Room +
	 "        ' onclick='ShowEdit(" + RoomID +"," + RoomIDButton + ");'>" +

         /* Description */
         "   <label>\n" +
         "       <input id=" + AliasID       + " type='hidden' "+
	 "           value='" + Alias + "'>\n" + 
	 "       <input id=" + AliasIDButton + " type='button' value='" + Alias +
	 "        ' onclick='ShowEdit(" + AliasID +"," + AliasIDButton + ");'>" +
	 "    </label>";
	 
         /* States choice */
	 HTMLDevice += 
	   " <table cellpadding='0' cellspacing='0' class='DeviceTable'>" +
	   "  <tr class='header'>" +
	   "    <td><img src='img/star.png' width='12' alt='Favourites'></td>" +
	   "    <td><img src='img/dict.png' width='12' alt='Dictation'></td>" +
	   "    <td align='left'>State</td>" +
	   "  </tr>";
	 
         var AddedToggle  = false;
         var AddedOn      = false;
         var AddedOff     = false;
         var StateChecked = false;
         for (var s in StatesArr) {
           if (StatesArr[s].Check == MenuState) {
             StateChecked = true;
             continue;
           }
	   HTMLDevice += AddCfgDevState2Device(i, StatesArr[s]);
           if (StatesArr[s].State == "toggle")
             AddedToggle = true;
           if (StatesArr[s].State == "on")
             AddedOn = true;
           if (StatesArr[s].State == "off")
             AddedOff = true;
         }

         if (!AddedToggle)
  	   HTMLDevice += AddState2Device(i, FHEM_Devices[DeviceType], "toggle", "toggle");

         if (!AddedOn)
 	   HTMLDevice += AddState2Device(i, FHEM_Devices[DeviceType], 'on', 'on');

         if (!AddedOff)
  	   HTMLDevice += AddState2Device(i, FHEM_Devices[DeviceType], 'off', 'off');

         // state:
         var CheckedStr = (StateChecked) ? "checked" : "";

	 HTMLDevice +=
	   "  <tr>" +
	   "    <td><label>" +
           "       <input id='Device_" + i + "_state' type='checkbox' "
                    + CheckedStr + 
           "        onclick='CheckDevice(\"" + DeviceID + "\");'>\n" +
	   "    </label></td>" +
	   "    <td></td>" +
	   "    <td>State of Device</td>" +
	   "  </tr>";

	 HTMLDevice += 
	   " </table>";
	   // "</div>";

//          if (false) {
         if (StateChecked || AddedToggle || AddedOn || AddedOff) {
           var Pos = FoundDevices;

           var ComIDDivI   = document.getElementById("ComItem_" + i);
           var ComIDDivPos = document.getElementById("ComItem_" + Pos);

           if (i != Pos) {
             // swap positions
             var tmp = ComIDDivPos.innerHTML;
             ComIDDivPos.innerHTML = HTMLDevice;
             ComIDDivI.innerHTML   = tmp;
           } else {
             ComIDDivPos.innerHTML = HTMLDevice;    
           }

           FoundDevices++;
         } else {
           var ComIDDiv = document.getElementById("ComItem_" + i);
           ComIDDiv.innerHTML = HTMLDevice;
         }
	 // HTMLElement.innerHTML += HTMLDevice;
    }
  }


  /////////////////////////////////////
  // Main Function
  (function() {
    var Cnt = 0;
    var CntObj = localStorage['FHEM_CONFIG_CNT'];
    if (CntObj == null) {
      localStorage['FHEM_CONFIG_CNT'] = JSON.stringify(Cnt);
    } else {
      Cnt = JSON.parse(CntObj);
      localStorage['FHEM_CONFIG_CNT'] = JSON.stringify(Cnt+1);
    }
    MyConsole("Config Counter: " + localStorage['FHEM_CONFIG_CNT']);
    
    var TagCommitNumber = document.getElementById('CommitNumber');
    MyConsole("Commit: "+ TagCommitNumber.innerHTML);
     
    // Server URL
    var FHEM_SERVER_URL_textinput = document.getElementById('FHEM_SERVER_URL');
    // Load any previously saved configuration, if available
    if(localStorage['FHEM_SERVER_URL']) {
      FHEM_SERVER_URL_textinput.value = localStorage['FHEM_SERVER_URL'];
    }

    // Room Filter
    var FHEM_ROOM_FILTER_textinput = document.getElementById('FHEM_ROOM_FILTER');
    // Load any previously saved configuration, if available
    if(localStorage['FHEM_ROOM_FILTER']) {
      FHEM_ROOM_FILTER_textinput.value = localStorage['FHEM_ROOM_FILTER'];
    }
    
    // for debugging: if args of URI are not present, the URI stays
    var DevicesElement=document.getElementById('FHEMDevices');
    if (Debug)
      DevicesElement.innerHTML = "URL of this document: <em>" +
        window.location.href + "</em>";
    else
      DevicesElement.innerHTML = "Go to settings on watch and press <em>Request</em>. Then return to this page to edit FHEM devices.";

    DeviceType = "FS20";
    ShowDevicesFromArgs(DeviceType, DevicesElement);

  })();
  </script>
</html>
